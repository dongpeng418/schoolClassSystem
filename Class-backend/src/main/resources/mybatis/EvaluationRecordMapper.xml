<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="cn.com.school.classinfo.mapper.EvaluationRecordMapper">
    <resultMap id="BaseResultMap" type="cn.com.school.classinfo.model.EvaluationRecord">
        <id column="id" property="id" jdbcType="INTEGER"/>
        <result property="tenantId" column="tenant_id" jdbcType="INTEGER"/>
        <result property="companyId" column="company_id" jdbcType="INTEGER"/>
        <result property="organizationId" column="organization_id" jdbcType="INTEGER"/>
        <result property="evalType" column="eval_type" jdbcType="INTEGER"/>
        <result property="evalCode" column="eval_code" jdbcType="VARCHAR"/>
        <result property="cityCode" column="city_code" jdbcType="VARCHAR"/>
        <result property="cityName" column="city_name" jdbcType="VARCHAR"/>
        <result property="distCode" column="dist_code" jdbcType="VARCHAR"/>
        <result property="distName" column="dist_name" jdbcType="VARCHAR"/>
        <result property="buildNo" column="build_no" jdbcType="VARCHAR"/>
        <result property="unit" column="unit" jdbcType="VARCHAR"/>
        <result property="roomNo" column="room_no" jdbcType="VARCHAR"/>
        <result property="propType" column="prop_type" jdbcType="VARCHAR"/>
        <result property="propTypeName" column="prop_type_name" jdbcType="VARCHAR"/>
        <result property="bldgArea" column="bldg_area" jdbcType="FLOAT"/>
        <result property="br" column="br" jdbcType="INTEGER"/>
        <result property="lr" column="lr" jdbcType="INTEGER"/>
        <result property="cr" column="cr" jdbcType="INTEGER"/>
        <result property="ba" column="ba" jdbcType="INTEGER"/>
        <result property="floor" column="floor" jdbcType="INTEGER"/>
        <result property="bheight" column="bheight" jdbcType="TIMESTAMP"/>
        <result property="faceCode" column="face_code" jdbcType="VARCHAR"/>
        <result property="faceName" column="face_name" jdbcType="VARCHAR"/>
        <result property="bldgTypeCode" column="bldg_type_code" jdbcType="VARCHAR"/>
        <result property="bldgTypeName" column="bldg_type_name" jdbcType="VARCHAR"/>
        <result property="buildYear" column="build_year" jdbcType="VARCHAR"/>
        <result property="intdecoCode" column="intdeco_code" jdbcType="VARCHAR"/>
        <result property="intdecoName" column="intdeco_name" jdbcType="VARCHAR"/>
        <result property="indoStruCode" column="indo_stru_code" jdbcType="VARCHAR"/>
        <result property="indoStruName" column="indo_stru_name" jdbcType="VARCHAR"/>
        <result property="proprtCode" column="proprt_code" jdbcType="VARCHAR"/>
        <result property="proprtName" column="proprt_name" jdbcType="VARCHAR"/>
        <result property="location" column="location" jdbcType="VARCHAR"/>
        <result property="haCode" column="ha_code" jdbcType="VARCHAR"/>
        <result property="haName" column="ha_name" jdbcType="VARCHAR"/>
        <result property="gpsLon" column="gps_lon" jdbcType="FLOAT"/>
        <result property="gpsLat" column="gps_lat" jdbcType="FLOAT"/>
        <result property="gpsType" column="gps_type" jdbcType="VARCHAR"/>
        <result property="unitPrice" column="unit_price" jdbcType="FLOAT"/>
        <result property="totalPrice" column="total_price" jdbcType="FLOAT"/>
        <result property="evalDate" column="eval_date" jdbcType="TIMESTAMP"/>
        <result property="samplePriceMax" column="sample_price_max" jdbcType="FLOAT"/>
        <result property="samplePriceMin" column="sample_price_min" jdbcType="FLOAT"/>
        <result property="samplePriceAvg" column="sample_price_avg" jdbcType="FLOAT"/>
        <result property="sampleCount" column="sample_count" jdbcType="INTEGER"/>
        <result property="inquiry" column="inquiry" jdbcType="INTEGER"/>
        <result property="advisory" column="advisory" jdbcType="INTEGER"/>
        <result property="historyCount" column="history_count" jdbcType="INTEGER"/>
        <result property="principal" column="principal" jdbcType="VARCHAR"/>
        <result property="owner" column="owner" jdbcType="VARCHAR"/>
        <result property="cardAddress" column="card_address" jdbcType="VARCHAR"/>
        <result property="cardAddress" column="card_address" jdbcType="VARCHAR"/>
        <result property="businessTypeId" column="business_type_id" jdbcType="INTEGER"/>
        <result property="createTime" column="create_time" jdbcType="TIMESTAMP"/>
        <result property="createBy" column="create_by" jdbcType="VARCHAR"/>
        <result property="createName" column="create_name" jdbcType="VARCHAR"/>
        <result property="updateTime" column="update_time" jdbcType="TIMESTAMP"/>
        <result property="updateBy" column="update_by" jdbcType="VARCHAR"/>
        <result property="updateName" column="update_name" jdbcType="VARCHAR"/>
    </resultMap>

    <sql id="Base_Column_List">
      id,tenant_id,organization_id,eval_type,eval_code,city_code,city_name,dist_code,dist_name,build_no,unit,room_no,prop_type,
      prop_type_name,bldg_area,br,lr,cr,ba,floor,bheight,face_code,face_name,bldg_type_code,bldg_type_name,build_year,
      intdeco_code,intdeco_name,indo_stru_code,indo_stru_name,proprt_code,proprt_name,location,ha_code,ha_name,gps_lon,
      gps_lat,gps_type,unit_price,total_price,eval_date,inquiry,advisory,history_count,asset,sample_price_max,
      sample_price_min,sample_price_avg,sample_count,principal,owner,card_address,business_type_id,
      create_time,create_by,create_name,update_time,update_by,update_name
    </sql>

    <sql id="Part_Column_List">
      id,tenant_id,organization_id,eval_type,eval_code,city_code,city_name,dist_code,dist_name,build_no,unit,room_no,prop_type,
      prop_type_name,bldg_area,br,lr,cr,ba,floor,bheight,face_code,face_name,bldg_type_code,bldg_type_name,build_year,
      intdeco_code,intdeco_name,indo_stru_code,indo_stru_name,proprt_code,proprt_name,location,ha_code,ha_name,gps_lon,
      gps_lat,gps_type,unit_price,total_price,eval_date,inquiry,advisory,history_count,asset,sample_price_max,
      sample_price_min,sample_price_avg,sample_count,principal,owner,card_address,business_type_id
    </sql>

    <sql id="Join_Column_List">
      record.id,record.tenant_id,record.organization_id,record.eval_type,record.eval_code,record.city_code,
      record.city_name,record.dist_code,record.dist_name,record.build_no,record.unit,record.room_no,record.prop_type,
      record.prop_type_name,record.bldg_area,record.br,record.lr,record.cr,record.ba,record.floor,record.bheight,
      record.face_code,record.face_name,record.bldg_type_code,record.bldg_type_name,record.build_year,
      record.intdeco_code,record.intdeco_name,record.indo_stru_code,record.indo_stru_name,record.proprt_code,
      record.proprt_name,record.location,record.ha_code,record.ha_name,record.gps_lon,
      record.gps_lat,record.gps_type,record.unit_price,record.total_price,record.eval_date,
      record.inquiry,record.advisory,record.history_count,record.asset,record.sample_price_max,
      record.sample_price_min,record.sample_price_avg,record.sample_count,record.principal,
      record.owner,record.card_address,record.business_type_id
    </sql>

    <insert id="insert" parameterType="cn.com.school.classinfo.model.EvaluationRecord" useGeneratedKeys="true"
            keyProperty="id">
        insert into evaluation_record(
          tenant_id, company_id, organization_id, eval_type, eval_code, city_code, city_name, dist_code, dist_name, build_no, unit,
          room_no, prop_type, prop_type_name, bldg_area, br, lr, cr, ba, floor, bheight,
          face_code, face_name, bldg_type_code, bldg_type_name, build_year, intdeco_code,
          intdeco_name, indo_stru_code, indo_stru_name, proprt_code, proprt_name, location,
          ha_code, ha_name, gps_lon, gps_lat, gps_type, unit_price, total_price, eval_date,
          sample_price_max, sample_price_min, sample_price_avg, sample_count,
          principal, owner, card_address, business_type_id,
          create_time, create_by, create_name, update_time, update_by, update_name) 
        values(
          #{tenantId}, #{companyId}, #{organizationId}, #{evalType}, #{evalCode}, #{cityCode}, #{cityName}, #{distCode}, #{distName},
          #{buildNo}, #{unit}, #{roomNo}, #{propType}, #{propTypeName}, #{bldgArea}, #{br}, #{lr}, #{cr},
          #{ba}, #{floor}, #{bheight}, #{faceCode}, #{faceName}, #{bldgTypeCode}, #{bldgTypeName},
          #{buildYear}, #{intdecoCode}, #{intdecoName}, #{indoStruCode}, #{indoStruName},
          #{proprtCode}, #{proprtName}, #{location}, #{haCode}, #{haName}, #{gpsLon}, #{gpsLat},
          #{gpsType}, #{unitPrice}, #{totalPrice}, #{evalDate}, 
          #{samplePriceMax}, #{samplePriceMin}, #{samplePriceAvg}, #{sampleCount},
          #{principal}, #{owner}, #{cardAddress}, #{businessTypeId},
          now(), #{createBy}, #{createName}, now(), #{updateBy}, #{updateName}
        )
    </insert>

    <update id="update" parameterType="cn.com.school.classinfo.model.EvaluationRecord">
        update evaluation_record
        <trim prefix='set' suffixOverrides=','>
            <if test='inquiry != null'>
                inquiry = #{inquiry},
            </if>
            <if test='advisory != null'>
                advisory = #{advisory},
            </if>
            <if test='evalCode != null'>
                eval_code = #{evalCode},
            </if>
            <if test='totalPrice != null'>
                total_price = #{totalPrice},
            </if>
            <if test='unitPrice != null'>
                unit_price = #{unitPrice},
            </if>
            <if test='evalDate != null'>
                eval_date = #{evalDate},
            </if>
            <if test='historyCount != null'>
                history_count = #{historyCount},
            </if>
            <if test='asset != null'>
                asset = #{asset},
            </if>
            update_time = now(),
            update_by = #{updateBy},
            update_name = #{updateName}
        </trim>
        where id = #{id}
    </update>

    <select id="selectByQuery" resultMap="BaseResultMap" parameterType="cn.com.school.classinfo.common.query.EvalQuery">
        select
        <include refid="Part_Column_List"/>
        from evaluation_record
        where update_by = #{loginUser}
        <if test='evalRecordId != null'>
            and id = #{evalRecordId}
        </if>
        <if test='evalCode != null'>
            and eval_code = #{evalCode}
        </if>
    </select>

    <select id="selectListByQuery" resultMap="BaseResultMap" parameterType="cn.com.school.classinfo.common.query.EvalQuery">

        <if test="type != null">
            SELECT
              DISTINCT <include refid="Join_Column_List"/>
            FROM   evaluation_record record
            LEFT JOIN evaluation_record_history history
            ON record.id = history.eval_id
            <trim prefix='WHERE' prefixOverrides='AND |OR'>
                <if test='city != null'>
                    AND record.city_name LIKE CONCAT('%',#{city},'%')
                </if>
                <if test='ha != null'>
                    AND record.ha_name LIKE CONCAT('%',#{ha},'%')
                </if>
                <if test='location != null'>
                    AND record.location LIKE CONCAT('%',#{location},'%')
                </if>
                <if test='evalType != null'>
                    AND record.eval_type = #{evalType}
                </if>
                <if test='type == 1'>
                    AND (record.inquiry = 1 OR history.inquiry = 1)
                </if>
                <if test='type == 2'>
                    AND (record.advisory = 1 OR history.advisory = 1)
                </if>
                <if test='beginDate != null'>
                    <![CDATA[ AND DATE_FORMAT(record.eval_date, '%Y-%m-%d') >= DATE_FORMAT(#{beginDate}, '%Y-%m-%d')]]>
                </if>
                <if test='endDate != null'>
                    <![CDATA[ AND DATE_FORMAT(record.eval_date, '%Y-%m-%d') <= DATE_FORMAT(#{endDate}, '%Y-%m-%d')]]>
                </if>
                AND record.update_by = #{loginUser}
                AND record.company_id = #{companyId}
            </trim>
            order by eval_date desc
        </if>
        <if test="type == null">
            select
            <include refid="Part_Column_List"/>
            from evaluation_record
            <trim prefix='WHERE' prefixOverrides='AND |OR'>
                <if test='city != null'>
                    AND city_name LIKE CONCAT('%',#{city},'%')
                </if>
                <if test='ha != null'>
                    AND ha_name LIKE CONCAT('%',#{ha},'%')
                </if>
                <if test='location != null'>
                    AND location LIKE CONCAT('%',#{location},'%')
                </if>
                <if test='evalType != null'>
                    AND eval_type = #{evalType}
                </if>
                <if test='beginDate != null'>
                    <![CDATA[ AND DATE_FORMAT(eval_date, '%Y-%m-%d') >= DATE_FORMAT(#{beginDate}, '%Y-%m-%d')]]>
                </if>
                <if test='endDate != null'>
                    <![CDATA[ AND DATE_FORMAT(eval_date, '%Y-%m-%d') <= DATE_FORMAT(#{endDate}, '%Y-%m-%d')]]>
                </if>
                AND update_by = #{loginUser}
                AND company_id = #{companyId}
            </trim>
            order by eval_date desc
        </if>
    </select>

</mapper>